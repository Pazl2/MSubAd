<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title><%= title || 'Обзор станций' %></title>
  <link rel="stylesheet" href="/static/css/header.css" />
  <link rel="stylesheet" href="/static/css/footer.css" />
  <link rel="stylesheet" href="/static/css/catalog.css" />
</head>
<body>
  <header><%- include('blocks/header') %></header>

  <main class="site-main">
    <!-- Hero -->
    <section class="hero" role="banner">
      <div class="container">
        <h1 class="hero-title">Обзор станций и рекламных мест</h1>
        <p class="hero-sub">Удобный каталог рекламных позиций в метро и в поездах + интерактивный обзор станций.</p>
      </div>
    </section>

    <!-- Ads toolbar: поиск и фильтр -->
    <div class="container">
      <div class="ads-toolbar" role="search">
        <input id="ads-search" class="ads-search" type="search" placeholder="Поиск по названиям и описанию..." aria-label="Поиск рекламы">
      </div>
    </div>

    <!-- Ads: full-width sections -->
    <section class="ads-section ads-section--metro">
      <div class="ads-inner container">
        <header class="ads-header">
          <h2>Реклама на станции</h2>
          <p class="ads-note">Похожие по формату и расположению места</p>
        </header>

        <div id="ads-metro-container" class="ads-grid">
          <!-- Server fallback -->
          <% if (ads && ads.length) { %>
            <% for (var i = 0; i < ads.length; i++) { 
                 var ad = ads[i];
                 if (!ad.location) { %>
              <article class="ad-card" data-location="<%= ad.location ? 'train' : 'metro' %>" data-search="<%= (ad.name + ' ' + (ad.description||'')).replace(/"/g,'') %>">
                <% if (ad.image_url) { %>
                  <div class="ad-card__img" style="background-image:url('<%= ad.image_url %>')" role="img" aria-label="<%= ad.name %>"></div>
                <% } else { 
                     // Пропорциональное масштабирование для server-side
                     var w = parseInt(ad.width) || 100, h = parseInt(ad.height) || 50;
                     var maxSide = 180;
                     var scale = Math.min(maxSide / w, maxSide / h, 1);
                     var svgW = Math.round(w * scale), svgH = Math.round(h * scale);
                     var sizeText = (ad.width || '-') + '×' + (ad.height || '-');
                %>
                  <div class="ad-card__img ad-card__img--placeholder" aria-hidden="true" style="display:flex;align-items:center;justify-content:center;">
                    <svg width="<%= svgW %>" height="<%= svgH %>" viewBox="0 0 <%= svgW %> <%= svgH %>" style="background:#f5f5f5;border-radius:6px;">
                      <rect x="0" y="0" width="<%= svgW %>" height="<%= svgH %>" rx="8" fill="#fdecea" stroke="#c62828" stroke-width="2"/>
                      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="18" fill="#c62828" font-family="Segoe UI, Arial" font-weight="bold"><%= sizeText %></text>
                    </svg>
                  </div>
                <% } %>

                <div class="ad-card__body">
                  <div class="ad-card__meta">
                    <h3 class="ad-card__title"><%= ad.name %></h3>
                  </div>

                  <p class="ad-card__desc"><%= ad.description %></p>

                  <div class="ad-card__footer">
                    <div class="ad-card__price"><%= ad.base_price != null ? ad.base_price + ' Br' : 'Свяжитесь' %></div>
                  </div>

                  <div class="ad-card__actions">
                    <button class="btn btn--ghost" type="button">Заказать</button>
                  </div>
                </div>
              </article>
            <%   } 
               } %>
          <% } %>
        </div>
      </div>
    </section>

    <section class="ads-section ads-section--train">
      <div class="ads-inner container">
        <header class="ads-header">
          <h2>Реклама в поезде</h2>
          <p class="ads-note">Наборы для размещения внутри вагонов</p>
        </header>

        <div id="ads-train-container" class="ads-grid">
          <!-- Server fallback -->
          <% if (ads && ads.length) { %>
            <% for (var j = 0; j < ads.length; j++) { 
                 var ad2 = ads[j];
                 if (ad2.location) { %>
              <article class="ad-card" data-location="<%= ad2.location ? 'train' : 'metro' %>" data-search="<%= (ad2.name + ' ' + (ad2.description||'')).replace(/"/g,'') %>">
                <% if (ad2.image_url) { %>
                  <div class="ad-card__img" style="background-image:url('<%= ad2.image_url %>')" role="img" aria-label="<%= ad2.name %>"></div>
                <% } else { 
                     var w2 = parseInt(ad2.width) || 100, h2 = parseInt(ad2.height) || 50;
                     var maxSide2 = 180;
                     var scale2 = Math.min(maxSide2 / w2, maxSide2 / h2, 1);
                     var svgW2 = Math.round(w2 * scale2), svgH2 = Math.round(h2 * scale2);
                     var sizeText2 = (ad2.width || '-') + '×' + (ad2.height || '-');
                %>
                  <div class="ad-card__img ad-card__img--placeholder" aria-hidden="true" style="display:flex;align-items:center;justify-content:center;">
                    <svg width="<%= svgW2 %>" height="<%= svgH2 %>" viewBox="0 0 <%= svgW2 %> <%= svgH2 %>" style="background:#f5f5f5;border-radius:6px;">
                      <rect x="0" y="0" width="<%= svgW2 %>" height="<%= svgH2 %>" rx="8" fill="#eef7ff" stroke="#1565c0" stroke-width="2"/>
                      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="18" fill="#1565c0" font-family="Segoe UI, Arial" font-weight="bold"><%= sizeText2 %></text>
                    </svg>
                  </div>
                <% } %>

                <div class="ad-card__body">
                  <div class="ad-card__meta">
                    <h3 class="ad-card__title"><%= ad2.name %></h3>
                  </div>

                  <p class="ad-card__desc"><%= ad2.description %></p>

                  <div class="ad-card__footer">
                    <div class="ad-card__price"><%= ad2.base_price != null ? ad2.base_price + ' Br' : 'Свяжитесь' %></div>
                  </div>

                  <div class="ad-card__actions">
                    <button class="btn btn--ghost" type="button">Заказать</button>
                  </div>
                </div>
              </article>
            <%   } 
               } %>
          <% } %>
        </div>
      </div>
    </section>

    <!-- Lines -->
    <div class="container">
      <section class="lines-overview">
        <h2 class="section-title">Линии метро</h2>
        <div id="line-buttons" class="line-chips">
          <% if (lines) { lines.forEach(function(line){ %>
            <button class="line-chip" data-tab="line" data-line-id="<%= line.id %>" style="--line-color:<%= line.color_code %>">
              <span class="line-chip__dot" aria-hidden="true"></span>
              <span class="line-chip__name"><%= line.name %></span>
            </button>
          <% }) } %>
        </div>
      </section>

      <!-- Stations carousel + details -->
      <section id="stations-section" class="stations-section" style="display:none;">
        <h3 id="selected-line-name" class="stations-title"></h3>
        <div id="station-carousel" class="station-carousel" role="list"></div>
      </section>

      <section id="station-section" class="station-details" style="display:none;">
        <h3 id="station-name"></h3>
        <dl class="station-meta">
          <div><dt>Номер станции:</dt><dd id="station-id"></dd></div>
          <div><dt>Год открытия:</dt><dd id="station-opening-year"></dd></div>
          <div><dt>Пассажиропоток:</dt><dd id="station-passenger-flow"></dd></div>
          <div><dt>Линия:</dt><dd id="station-line"></dd></div>
        </dl>
        <p id="station-description" class="station-desc"></p>
        <p class="station-location"><strong>Локация:</strong> <span id="station-location"></span></p>
      </section>

      <div id="error-message" class="error-message" role="alert" style="display:none;"></div>
    </div>
  </main>

  <script src="/static/js/catalog.js"></script>
  <footer><%- include('blocks/footer') %></footer>
</body>
</html>
