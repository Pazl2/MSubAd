<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - MSubAd</title>
  <link rel="stylesheet" href="/static/css/cabinet-header.css" />
  <link rel="stylesheet" href="/static/css/header.css" />
  <link rel="stylesheet" href="/static/css/footer.css" />
  <link rel="stylesheet" href="/static/css/cabinet.css" />
</head>
<body>
  <header class="header"><%- include('blocks/header') %></header>

  <div class="cabinet-layout">
    <div class="cabinet-sidebar"><%- include('blocks/cabinet-header', { user: user }) %></div>

    <div class="cabinet-main">
      <div class="cabinet-content">
        <div class="content-header">
            <h2 id="pageTitle">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
            <div class="user-welcome">
                –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span><%= user.first_name %> <%= user.last_name %></span>!
                <% if (user.is_moder) { %>
                    <span class="moder-badge">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                <% } %>
            </div>
        </div>

        <!-- Account View Mode -->
        <div class="cabinet-info-large" id="viewMode">
          <div class="info-section">
            <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">–õ–æ–≥–∏–Ω:</span><span class="info-value"><%= user.username %></span></div>
              <div class="info-item"><span class="info-label">–ò–º—è:</span><span class="info-value" id="view-first_name"><%= user.first_name %></span></div>
              <div class="info-item"><span class="info-label">–§–∞–º–∏–ª–∏—è:</span><span class="info-value" id="view-last_name"><%= user.last_name %></span></div>
              <div class="info-item"><span class="info-label">–û—Ç—á–µ—Å—Ç–≤–æ:</span><span class="info-value" id="view-father_name"><%= user.father_name %></span></div>
            </div>
          </div>

          <div class="info-section">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">Email:</span><span class="info-value" id="view-email"><%= user.email %></span></div>
              <div class="info-item"><span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span><span class="info-value" id="view-phone"><%= user.phone %></span></div>
            </div>
          </div>

          <div class="info-section">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span><span class="info-value"><%= new Date(user.registration_date).toLocaleString('ru-RU') %></span></div>
              <div class="info-item"><span class="info-label">–°—Ç–∞—Ç—É—Å:</span><span class="info-value"><%= user.is_moder ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' %></span></div>
            </div>
          </div>

          <button class="edit-button" onclick="toggleEditMode()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <!-- Account Edit Mode -->
        <form id="editMode" style="display: none;" onsubmit="saveChanges(event)">
          <div class="cabinet-info-large">
            <div class="info-section">
              <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">–õ–æ–≥–∏–Ω:</span>
                  <span class="info-value"><%= user.username %></span>
                </div>
                <div class="info-item">
                  <span class="info-label">–ò–º—è:</span>
                  <input type="text" name="first_name" value="<%= user.first_name %>" class="edit-input" required>
                </div>
                <div class="info-item">
                  <span class="info-label">–§–∞–º–∏–ª–∏—è:</span>
                  <input type="text" name="last_name" value="<%= user.last_name %>" class="edit-input" required>
                </div>
                <div class="info-item">
                  <span class="info-label">–û—Ç—á–µ—Å—Ç–≤–æ:</span>
                  <input type="text" name="father_name" value="<%= user.father_name %>" class="edit-input" required>
                </div>
              </div>
            </div>

            <div class="info-section">
              <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Email:</span>
                  <input type="email" name="email" value="<%= user.email %>" class="edit-input" required>
                  <span class="error-message" id="email-error"></span>
                </div>
                <div class="info-item">
                  <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  <input type="text" name="phone" value="<%= user.phone %>" class="edit-input" required>
                </div>
              </div>
            </div>

            <div class="info-section">
              <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
              <div class="info-grid">
                <div class="info-item"><span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span><span class="info-value"><%= new Date(user.registration_date).toLocaleString('ru-RU') %></span></div>
                <div class="info-item"><span class="info-label">–°—Ç–∞—Ç—É—Å:</span><span class="info-value"><%= user.is_moder ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' %></span></div>
              </div>
            </div>

            <div class="button-group">
              <button type="submit" class="confirm-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
              <button type="button" class="cancel-button" onclick="toggleEditMode()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        </form>

        <!-- User Management -->
        <div id="manageUsersMode" style="display: none;">
          <div class="cabinet-info-large">
            <div class="button-download-wrapper">
              <button type="button" class="download-button" onclick="downloadUsersDatabase()">
                <span class="download-icon">üì•</span>–°–∫–∞—á–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
              </button>
            </div>

            <div class="info-section">
              <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>
              <div class="form-group">
                <label class="form-label">–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="changeRoleUsername" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                <label class="form-label">–ù–æ–≤–∞—è —Ä–æ–ª—å:</label>
                <select id="roleSelect" class="form-select">
                  <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                  <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                </select>
                <button type="button" class="confirm-button" onclick="changeUserRole()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <span class="error-message" id="changeRoleError"></span>
              </div>
            </div>

            <div class="info-section">
              <h3>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
              <div class="form-group">
                <label class="form-label">–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="deleteUsername" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                <button type="button" class="confirm-button delete-button" onclick="deleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
                <span class="error-message" id="deleteUserError"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer><%- include('blocks/footer') %></footer>

  <script>
    function toggleEditMode() {
      const viewMode = document.getElementById('viewMode');
      const editMode = document.getElementById('editMode');
      
      if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
      } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
      }
    }

    function saveChanges(event) {
      event.preventDefault();
      const emailInput = document.querySelector('input[name="email"]');
      const emailError = document.getElementById('email-error');

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailInput.value)) {
        emailError.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
        return;
      }
      emailError.textContent = '';

      const formData = {
        first_name: document.querySelector('input[name="first_name"]').value,
        last_name: document.querySelector('input[name="last_name"]').value,
        father_name: document.querySelector('input[name="father_name"]').value,
        email: emailInput.value,
        phone: document.querySelector('input[name="phone"]').value
      };

      fetch('/cabinet/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('view-first_name').textContent = formData.first_name;
          document.getElementById('view-last_name').textContent = formData.last_name;
          document.getElementById('view-father_name').textContent = formData.father_name;
          document.getElementById('view-email').textContent = formData.email;
          document.getElementById('view-phone').textContent = formData.phone;
          toggleEditMode();
          alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      })
      .catch(err => {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
      });
    }

    function showManageUsers() {
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editMode').style.display = 'none';
      document.getElementById('manageUsersMode').style.display = 'block';
      document.getElementById('pageTitle').textContent = '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏';
      updateNavLink('manage-users');
    }

    function showAccount() {
      document.getElementById('viewMode').style.display = 'block';
      document.getElementById('editMode').style.display = 'none';
      document.getElementById('manageUsersMode').style.display = 'none';
      document.getElementById('pageTitle').textContent = '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç';
      updateNavLink('account');
    }

    function updateNavLink(page) {
      const links = document.querySelectorAll('.cabinet-nav .nav-link');
      links.forEach(link => link.classList.remove('active'));
      
      if (page === 'account') {
        // –ò—â–µ–º –ø–µ—Ä–≤—É—é —Å—Å—ã–ª–∫—É –≤ –º–µ–Ω—é (–ê–∫–∫–∞—É–Ω—Ç)
        const accountLink = document.querySelector('.cabinet-nav .nav-menu .nav-item:first-child .nav-link');
        if (accountLink) {
          accountLink.classList.add('active');
        }
      } else if (page === 'manage-users') {
        // –ò—â–µ–º —Å—Å—ã–ª–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –ø–æ onclick –∞—Ç—Ä–∏–±—É—Ç—É –∏–ª–∏ –∫–ª–∞—Å—Å—É
        const manageLink = Array.from(links).find(link => link.textContent.includes('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏'));
        if (manageLink) {
          manageLink.classList.add('active');
        }
      }
    }

    function changeUserRole() {
      const username = document.getElementById('changeRoleUsername').value.trim();
      const role = document.getElementById('roleSelect').value;
      const errorEl = document.getElementById('changeRoleError');
      errorEl.textContent = '';

      if (!username) {
        errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        return;
      }

      if (role === 'moderator') {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–∞—Ç—å —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∞–≤–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞?')) {
          return;
        }
      }

      fetch('/cabinet/change-role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, role })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          document.getElementById('changeRoleUsername').value = '';
        } else {
          errorEl.textContent = data.message;
        }
      })
      .catch(err => {
        console.error(err);
        errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
      });
    }

    function deleteUser() {
      const username = document.getElementById('deleteUsername').value.trim();
      const errorEl = document.getElementById('deleteUserError');
      errorEl.textContent = '';

      if (!username) {
        errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        return;
      }

      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
        return;
      }

      fetch('/cabinet/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          document.getElementById('deleteUsername').value = '';
        } else {
          errorEl.textContent = data.message;
        }
      })
      .catch(err => {
        console.error(err);
        errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
      });
    }

    function downloadUsersDatabase() {
      fetch('/cabinet/download-users')
        .then(response => {
          if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏');
          }
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'users_database.xlsx';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          console.error(err);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
        });
    }
  </script>
</body>
</html>
