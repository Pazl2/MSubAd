<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - MSubAd</title>
  <link rel="stylesheet" href="/static/css/cabinet-header.css" />
  <link rel="stylesheet" href="/static/css/header.css" />
  <link rel="stylesheet" href="/static/css/footer.css" />
  <link rel="stylesheet" href="/static/css/cabinet.css" />
</head>
<body>
  <header class="header"><%- include('blocks/header') %></header>

  <div class="cabinet-layout">
    <div class="cabinet-sidebar"><%- include('blocks/cabinet-header', { user: user }) %></div>

    <div class="cabinet-main">
      <div class="cabinet-content">
        <div class="content-header">
            <h2 id="pageTitle">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
            <div class="user-welcome">
                –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span><%= user.first_name %> <%= user.last_name %></span>!
                <% if (user.is_moder) { %>
                    <span class="moder-badge">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                <% } %>
            </div>
        </div>

        <!-- Account View Mode -->
        <div class="cabinet-info-large" id="viewMode">
          <div class="info-section">
            <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">–õ–æ–≥–∏–Ω:</span><span class="info-value"><%= user.username %></span></div>
              <div class="info-item"><span class="info-label">–ò–º—è:</span><span class="info-value" id="view-first_name"><%= user.first_name %></span></div>
              <div class="info-item"><span class="info-label">–§–∞–º–∏–ª–∏—è:</span><span class="info-value" id="view-last_name"><%= user.last_name %></span></div>
              <div class="info-item"><span class="info-label">–û—Ç—á–µ—Å—Ç–≤–æ:</span><span class="info-value" id="view-father_name"><%= user.father_name %></span></div>
            </div>
          </div>

          <div class="info-section">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">Email:</span><span class="info-value" id="view-email"><%= user.email %></span></div>
              <div class="info-item"><span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span><span class="info-value" id="view-phone"><%= user.phone %></span></div>
            </div>
          </div>

          <div class="info-section">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span><span class="info-value"><%= new Date(user.registration_date).toLocaleString('ru-RU') %></span></div>
              <div class="info-item"><span class="info-label">–°—Ç–∞—Ç—É—Å:</span><span class="info-value"><%= user.is_moder ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' %></span></div>
            </div>
          </div>

          <button class="edit-button" onclick="toggleEditMode()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <!-- Account Edit Mode -->
        <form id="editMode" style="display: none;" onsubmit="saveChanges(event)">
          <div class="cabinet-info-large">
            <div class="info-section">
              <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">–õ–æ–≥–∏–Ω:</span>
                  <span class="info-value"><%= user.username %></span>
                </div>
                <div class="info-item">
                  <span class="info-label">–ò–º—è:</span>
                  <input type="text" name="first_name" value="<%= user.first_name %>" class="edit-input" required>
                </div>
                <div class="info-item">
                  <span class="info-label">–§–∞–º–∏–ª–∏—è:</span>
                  <input type="text" name="last_name" value="<%= user.last_name %>" class="edit-input" required>
                </div>
                <div class="info-item">
                  <span class="info-label">–û—Ç—á–µ—Å—Ç–≤–æ:</span>
                  <input type="text" name="father_name" value="<%= user.father_name %>" class="edit-input" required>
                </div>
              </div>
            </div>

            <div class="info-section">
              <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Email:</span>
                  <input type="email" name="email" value="<%= user.email %>" class="edit-input" required>
                  <span class="error-message" id="email-error"></span>
                </div>
                <div class="info-item">
                  <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  <input type="text" name="phone" value="<%= user.phone %>" class="edit-input" required>
                </div>
              </div>
            </div>

            <div class="info-section">
              <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
              <div class="info-grid">
                <div class="info-item"><span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span><span class="info-value"><%= new Date(user.registration_date).toLocaleString('ru-RU') %></span></div>
                <div class="info-item"><span class="info-label">–°—Ç–∞—Ç—É—Å:</span><span class="info-value"><%= user.is_moder ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' %></span></div>
              </div>
            </div>

            <div class="button-group">
              <button type="submit" class="confirm-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
              <button type="button" class="cancel-button" onclick="toggleEditMode()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        </form>

        <!-- User Management -->
        <div id="manageUsersMode" style="display: none;">
          <div class="cabinet-info-large">
            <div class="button-download-wrapper">
              <button type="button" class="download-button" onclick="downloadUsersDatabase()">
                <span class="download-icon">üì•</span>–°–∫–∞—á–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
              </button>
            </div>

            <div class="info-section">
              <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>
              <div class="form-group">
                <label class="form-label">–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="changeRoleUsername" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                <label class="form-label">–ù–æ–≤–∞—è —Ä–æ–ª—å:</label>
                <select id="roleSelect" class="form-select">
                  <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                  <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                </select>
                <button type="button" class="confirm-button" onclick="changeUserRole()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <span class="error-message" id="changeRoleError"></span>
              </div>
            </div>

            <div class="info-section">
              <h3>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
              <div class="form-group">
                <label class="form-label">–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="deleteUsername" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                <button type="button" class="confirm-button delete-button" onclick="deleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
                <span class="error-message" id="deleteUserError"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Ad Types Management -->
        <div id="manageAdTypesMode" style="display: none;">
          <div class="cabinet-info-large">
            <div class="info-section">
              <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ —Ä–µ–∫–ª–∞–º—ã</h3>
              <div class="form-group">
                <label class="form-label">–ò–º—è —Ç–∏–ø–∞:</label>
                <input type="text" id="adTypeName" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–Ω–Ω–µ—Ä">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="adTypeDescription" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ —Ä–µ–∫–ª–∞–º—ã" rows="3"></textarea>
                <label class="form-label">–®–∏—Ä–∏–Ω–∞ (px):</label>
                <input type="number" id="adTypeWidth" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É" min="1">
                <label class="form-label">–í—ã—Å–æ—Ç–∞ (px):</label>
                <input type="number" id="adTypeHeight" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É" min="1">
                <label class="form-label">–õ–æ–∫–∞—Ü–∏—è:</label>
                <select id="adTypeLocation" class="form-select">
                  <option value="0">–°—Ç–∞–Ω—Ü–∏—è</option>
                  <option value="1">–ü–æ–µ–∑–¥</option>
                </select>
                <label class="form-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞:</label>
                <input type="number" id="adTypeBasePrice" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É" min="0" step="0.01">
                <div class="button-group">
                  <button type="button" class="confirm-button" onclick="addAdType()">–î–æ–±–∞–≤–∏—Ç—å</button>
                  <button type="button" class="confirm-button" onclick="updateAdType()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
                <span class="error-message" id="adTypeError"></span>
              </div>
            </div>

            <div class="info-section">
              <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã —Ä–µ–∫–ª–∞–º—ã</h3>
              <div class="button-download-wrapper">
                <button type="button" class="download-button" onclick="downloadAdTypesDatabase()">
                  <span class="download-icon">üì•</span>–°–∫–∞—á–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                </button>
              </div>
              <div class="sort-wrapper">
                <label class="form-label" for="adTypeSort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ:</label>
                <select id="adTypeSort" class="form-select" onchange="loadAdTypes()">
                  <option value="none">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
                  <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                  <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                </select>
              </div>
              <div id="adTypesList" class="ad-types-list"></div>
            </div>
          </div>
        </div>

        <!-- Ad Spaces Management -->
        <div id="manageAdSpacesMode" style="display: none;">
          <div class="cabinet-info-large">
            <div class="info-section">
              <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏</h3>
              <div class="button-download-wrapper">
                <button type="button" class="download-button" onclick="downloadAdSpacesDatabase()">
                  <span class="download-icon">üì•</span>–°–∫–∞—á–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                </button>
              </div>
              <div class="form-group">
                <label class="form-label">–õ–æ–∫–∞—Ü–∏—è:</label>
                <select id="spaceLocation" class="form-select" onchange="updateSpaceOptions()">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é</option>
                  <option value="0">–°—Ç–∞–Ω—Ü–∏—è</option>
                  <option value="1">–ü–æ–µ–∑–¥</option>
                </select>

                <label class="form-label">–¢–∏–ø —Ä–µ–∫–ª–∞–º—ã:</label>
                <select id="spaceAdType" class="form-select" onchange="onSpaceTypeChange()">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–∫–ª–∞–º—ã</option>
                </select>

                <label class="form-label">–õ–∏–Ω–∏—è –º–µ—Ç—Ä–æ:</label>
                <select id="spaceLine" class="form-select" onchange="updateSpaceStationsOrTrains()">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–Ω–∏—é</option>
                </select>

                <label class="form-label" id="spaceStationLabel" style="display: none;">–°—Ç–∞–Ω—Ü–∏—è:</label>
                <select id="spaceStation" class="form-select" style="display: none;">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é</option>
                </select>

                <label class="form-label" id="spaceTrainLabel" style="display: none;">–ü–æ–µ–∑–¥:</label>
                <select id="spaceTrain" class="form-select" style="display: none;">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–µ–∑–¥</option>
                </select>

                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç:</label>
                <input type="number" id="spaceQuantity" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="1">

                <div class="button-group">
                  <button type="button" class="confirm-button" onclick="addAdSpaces()">–î–æ–±–∞–≤–∏—Ç—å</button>
                  <button type="button" class="confirm-button delete-button" onclick="deleteAdSpaces()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <span class="error-message" id="spaceError"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer><%- include('blocks/footer') %></footer>

  <script>
    function toggleEditMode() {
      const viewMode = document.getElementById('viewMode');
      const editMode = document.getElementById('editMode');
      
      if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
      } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
      }
    }

    function saveChanges(event) {
      event.preventDefault();
      const emailInput = document.querySelector('input[name="email"]');
      const emailError = document.getElementById('email-error');

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailInput.value)) {
        emailError.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
        return;
      }
      emailError.textContent = '';

      const formData = {
        first_name: document.querySelector('input[name="first_name"]').value,
        last_name: document.querySelector('input[name="last_name"]').value,
        father_name: document.querySelector('input[name="father_name"]').value,
        email: emailInput.value,
        phone: document.querySelector('input[name="phone"]').value
      };

      fetch('/cabinet/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('view-first_name').textContent = formData.first_name;
          document.getElementById('view-last_name').textContent = formData.last_name;
          document.getElementById('view-father_name').textContent = formData.father_name;
          document.getElementById('view-email').textContent = formData.email;
          document.getElementById('view-phone').textContent = formData.phone;
          toggleEditMode();
          alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      })
      .catch(err => {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
      });
    }

    function showManageUsers() {
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editMode').style.display = 'none';
      document.getElementById('manageUsersMode').style.display = 'block';
      document.getElementById('manageAdTypesMode').style.display = 'none';
      document.getElementById('manageAdSpacesMode').style.display = 'none';
      document.getElementById('pageTitle').textContent = '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏';
      updateNavLink('manage-users');
      clearAdTypeForm();
    }

    function showAccount() {
      document.getElementById('viewMode').style.display = 'block';
      document.getElementById('editMode').style.display = 'none';
      document.getElementById('manageUsersMode').style.display = 'none';
      document.getElementById('manageAdTypesMode').style.display = 'none';
      document.getElementById('manageAdSpacesMode').style.display = 'none';
      document.getElementById('pageTitle').textContent = '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç';
      updateNavLink('account');
    }

    function showManageAdTypes() {
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editMode').style.display = 'none';
      document.getElementById('manageUsersMode').style.display = 'none';
      document.getElementById('manageAdTypesMode').style.display = 'block';
      document.getElementById('manageAdSpacesMode').style.display = 'none';
      document.getElementById('pageTitle').textContent = '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ —Ä–µ–∫–ª–∞–º—ã';
      updateNavLink('manage-ad-types');
      loadAdTypes();
    }

    function showManageAdSpaces() {
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editMode').style.display = 'none';
      document.getElementById('manageUsersMode').style.display = 'none';
      document.getElementById('manageAdTypesMode').style.display = 'none';
      document.getElementById('manageAdSpacesMode').style.display = 'block';
      document.getElementById('pageTitle').textContent = '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏';
      updateNavLink('manage-ad-spaces');
      loadAdSpacesOptions();
    }

    function loadAdTypes() {
      fetch('/cabinet/get-ad-types')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            let adTypes = data.adTypes;
            const sortValue = document.getElementById('adTypeSort').value;
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ
            if (sortValue === 'asc') {
              adTypes.sort((a, b) => a.base_price - b.base_price);
            } else if (sortValue === 'desc') {
              adTypes.sort((a, b) => b.base_price - a.base_price);
            }

            const listContainer = document.getElementById('adTypesList');
            listContainer.innerHTML = '';
            if (adTypes.length === 0) {
              listContainer.innerHTML = '<p style="color: #999;">–¢–∏–ø—ã —Ä–µ–∫–ª–∞–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
              return;
            }
            adTypes.forEach(adType => {
              const item = document.createElement('div');
              item.className = 'ad-type-item';
              item.innerHTML = `
                <div class="ad-type-info">
                  <h4>${adType.name}</h4>
                  <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${adType.description}</p>
                  <p><strong>–†–∞–∑–º–µ—Ä:</strong> ${adType.width}x${adType.height}px</p>
                  <p><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> ${adType.location ? '–ü–æ–µ–∑–¥' : '–°—Ç–∞–Ω—Ü–∏—è'}</p>
                  <p><strong>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞:</strong> ${adType.base_price} Br</p>
                </div>
                <div class="ad-type-actions">
                  <button class="confirm-button" onclick="selectAdType(${adType.id}, '${adType.name}', '${adType.description}', ${adType.width}, ${adType.height}, ${adType.location}, ${adType.base_price})">–í—ã–±—Ä–∞—Ç—å</button>
                  <button class="delete-button" onclick="deleteAdType(${adType.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
              `;
              listContainer.appendChild(item);
            });
          }
        })
        .catch(err => {
          console.error(err);
        });
    }

    function selectAdType(id, name, description, width, height, location, basePrice) {
      document.getElementById('adTypeName').value = name;
      document.getElementById('adTypeDescription').value = description;
      document.getElementById('adTypeWidth').value = width;
      document.getElementById('adTypeHeight').value = height;
      document.getElementById('adTypeLocation').value = location ? '1' : '0';
      document.getElementById('adTypeBasePrice').value = basePrice;
      document.getElementById('adTypeName').dataset.adTypeId = id;
    }

    function addAdType() {
      const name = document.getElementById('adTypeName').value.trim();
      const description = document.getElementById('adTypeDescription').value.trim();
      const width = parseInt(document.getElementById('adTypeWidth').value);
      const height = parseInt(document.getElementById('adTypeHeight').value);
      const location = parseInt(document.getElementById('adTypeLocation').value);
      const basePrice = parseFloat(document.getElementById('adTypeBasePrice').value);
      const errorEl = document.getElementById('adTypeError');
      errorEl.textContent = '';

      if (!name || !description || !width || !height || !basePrice) {
        errorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
      }

      if (document.getElementById('adTypeName').dataset.adTypeId) {
        errorEl.textContent = '–û—á–∏—Å—Ç–∏—Ç–µ —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞';
        return;
      }

      fetch('/cabinet/add-ad-type', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, width, height, location, basePrice })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('–¢–∏–ø —Ä–µ–∫–ª–∞–º—ã —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
          document.getElementById('adTypeName').value = '';
          document.getElementById('adTypeDescription').value = '';
          document.getElementById('adTypeWidth').value = '';
          document.getElementById('adTypeHeight').value = '';
          document.getElementById('adTypeLocation').value = '0';
          document.getElementById('adTypeBasePrice').value = '';
          delete document.getElementById('adTypeName').dataset.adTypeId;
          loadAdTypes();
        } else {
          errorEl.textContent = data.message;
        }
      })
      .catch(err => {
        console.error(err);
        errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
      });
    }

    function updateAdType() {
      const adTypeId = document.getElementById('adTypeName').dataset.adTypeId;
      if (!adTypeId) {
        document.getElementById('adTypeError').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–∫–ª–∞–º—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        return;
      }

      const name = document.getElementById('adTypeName').value.trim();
      const description = document.getElementById('adTypeDescription').value.trim();
      const width = parseInt(document.getElementById('adTypeWidth').value);
      const height = parseInt(document.getElementById('adTypeHeight').value);
      const location = parseInt(document.getElementById('adTypeLocation').value);
      const basePrice = parseFloat(document.getElementById('adTypeBasePrice').value);
      const errorEl = document.getElementById('adTypeError');
      errorEl.textContent = '';

      if (!name || !description || !width || !height || !basePrice) {
        errorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
      }

      fetch('/cabinet/update-ad-type', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: adTypeId, name, description, width, height, location, basePrice })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('–¢–∏–ø —Ä–µ–∫–ª–∞–º—ã —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
          document.getElementById('adTypeName').value = '';
          document.getElementById('adTypeDescription').value = '';
          document.getElementById('adTypeWidth').value = '';
          document.getElementById('adTypeHeight').value = '';
          document.getElementById('adTypeLocation').value = '0';
          document.getElementById('adTypeBasePrice').value = '';
          delete document.getElementById('adTypeName').dataset.adTypeId;
          loadAdTypes();
        } else {
          errorEl.textContent = data.message;
        }
      })
      .catch(err => {
        console.error(err);
        errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
      });
    }

    function deleteAdType(id) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–∏–ø —Ä–µ–∫–ª–∞–º—ã?')) {
        return;
      }

      fetch('/cabinet/delete-ad-type', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('–¢–∏–ø —Ä–µ–∫–ª–∞–º—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
          loadAdTypes();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      })
      .catch(err => {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      });
    }

    function downloadUsersDatabase() {
      fetch('/cabinet/download-users')
        .then(response => {
          if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏');
          }
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'users_database.xlsx';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          console.error(err);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
        });
    }

    function downloadAdTypesDatabase() {
      fetch('/cabinet/download-ad-types')
        .then(response => {
          if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏');
          }
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'ad_types_database.xlsx';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          console.error(err);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
        });
    }

    function downloadAdSpacesDatabase() {
      fetch('/cabinet/download-ad-spaces')
        .then(response => {
          if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏');
          }
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'ad_spaces_database.xlsx';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          console.error(err);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –º–µ—Å—Ç');
        });
    }

    function loadAdSpacesOptions() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã —Ä–µ–∫–ª–∞–º—ã
      fetch('/cabinet/get-ad-types')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const select = document.getElementById('spaceAdType');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–∫–ª–∞–º—ã</option>';
            select.disabled = true;
            data.adTypes.forEach(type => {
              select.innerHTML += `<option value="${type.id}" data-location="${type.location ? '1' : '0'}">${type.name}</option>`;
            });
          }
        })
        .catch(err => console.error('Error loading ad types:', err));

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–Ω–∏–∏ –º–µ—Ç—Ä–æ
      fetch('/catalog/get-lines')
        .then(res => res.json())
        .then(data => {
          if (data.success && data.lines) {
            const select = document.getElementById('spaceLine');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–Ω–∏—é</option>';
            select.disabled = true;
            data.lines.forEach(line => {
              select.innerHTML += `<option value="${line.id}">${line.name}</option>`;
            });
          }
        })
        .catch(err => console.error('Error loading lines:', err));
    }

    function updateSpaceOptions() {
      const location = document.getElementById('spaceLocation').value;
      const adTypeSelect = document.getElementById('spaceAdType');
      const lineSelect = document.getElementById('spaceLine');

      document.getElementById('spaceStation').value = '';
      document.getElementById('spaceTrain').value = '';
      document.getElementById('spaceStationLabel').style.display = 'none';
      document.getElementById('spaceStation').style.display = 'none';
      document.getElementById('spaceTrainLabel').style.display = 'none';
      document.getElementById('spaceTrain').style.display = 'none';

      if (location) {
        adTypeSelect.disabled = false;
        const options = adTypeSelect.querySelectorAll('option[data-location]');
        options.forEach(opt => {
          if (opt.dataset.location === location) {
            opt.style.display = 'block';
          } else {
            opt.style.display = 'none';
          }
        });
        adTypeSelect.value = '';
        lineSelect.disabled = true;
        lineSelect.value = '';
      } else {
        adTypeSelect.disabled = true;
        adTypeSelect.value = '';
        lineSelect.disabled = true;
        lineSelect.value = '';
      }
    }

    function onSpaceTypeChange() {
      const typeId = document.getElementById('spaceAdType').value;
      const lineSelect = document.getElementById('spaceLine');
      if (typeId) {
        lineSelect.disabled = false;
      } else {
        lineSelect.disabled = true;
        lineSelect.value = '';
      }
    }

    function updateSpaceStationsOrTrains() {
      const location = document.getElementById('spaceLocation').value;
      const typeId = document.getElementById('spaceAdType').value;
      const lineId = document.getElementById('spaceLine').value;

      if (!location || !typeId || !lineId) return;

      if (location === '0') {
        document.getElementById('spaceStationLabel').style.display = 'block';
        document.getElementById('spaceStation').style.display = 'block';
        document.getElementById('spaceTrainLabel').style.display = 'none';
        document.getElementById('spaceTrain').style.display = 'none';

        fetch(`/catalog/get-stations?line_id=${lineId}`)
          .then(res => res.json())
          .then(data => {
            if (data.success && data.stations && data.stations.length > 0) {
              const select = document.getElementById('spaceStation');
              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é</option>';
              data.stations.forEach(station => {
                select.innerHTML += `<option value="${station.id}">${station.name}</option>`;
              });
            } else {
              document.getElementById('spaceStation').innerHTML = '<option value="">–°—Ç–∞–Ω—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
            }
          })
          .catch(err => {
            console.error('Error loading stations:', err);
            document.getElementById('spaceStation').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
          });
      } else if (location === '1') {
        document.getElementById('spaceStationLabel').style.display = 'none';
        document.getElementById('spaceStation').style.display = 'none';
        document.getElementById('spaceTrainLabel').style.display = 'block';
        document.getElementById('spaceTrain').style.display = 'block';

        fetch(`/catalog/get-trains?line_id=${lineId}`)
          .then(res => res.json())
          .then(data => {
            if (data.success && data.trains && data.trains.length > 0) {
              const select = document.getElementById('spaceTrain');
              select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–µ–∑–¥</option>';
              data.trains.forEach(train => {
                select.innerHTML += `<option value="${train.id}">${train.number}</option>`;
              });
            } else {
              document.getElementById('spaceTrain').innerHTML = '<option value="">–ü–æ–µ–∑–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
            }
          })
          .catch(err => {
            console.error('Error loading trains:', err);
            document.getElementById('spaceTrain').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
          });
      }
    }

    function addAdSpaces() {
      const location = parseInt(document.getElementById('spaceLocation').value);
      const typeId = parseInt(document.getElementById('spaceAdType').value);
      const quantity = parseInt(document.getElementById('spaceQuantity').value);
      const errorEl = document.getElementById('spaceError');
      errorEl.textContent = '';

      let stationId = null, trainId = null;

      if (location === 0) {
        stationId = parseInt(document.getElementById('spaceStation').value);
        if (!stationId || isNaN(stationId)) {
          errorEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é';
          return;
        }
      } else if (location === 1) {
        trainId = parseInt(document.getElementById('spaceTrain').value);
        if (!trainId || isNaN(trainId)) {
          errorEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–µ–∑–¥';
          return;
        }
      } else {
        errorEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é';
        return;
      }

      if (!typeId || isNaN(typeId) || !quantity || isNaN(quantity) || quantity < 1) {
        errorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ';
        return;
      }

      console.log('Adding ad spaces:', { typeId, quantity, stationId, trainId });

      fetch('/cabinet/add-ad-spaces', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ typeId, quantity, stationId, trainId })
      })
      .then(res => res.json())
      .then(data => {
        console.log('Response:', data);
        if (data.success) {
          alert(data.message);
          document.getElementById('spaceLocation').value = '';
          document.getElementById('spaceAdType').value = '';
          document.getElementById('spaceLine').value = '';
          document.getElementById('spaceStation').value = '';
          document.getElementById('spaceTrain').value = '';
          document.getElementById('spaceQuantity').value = '';
          updateSpaceOptions();
        } else {
          errorEl.textContent = data.message;
        }
      })
      .catch(err => {
        console.error(err);
        errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
      });
    }

    function deleteAdSpaces() {
      const location = parseInt(document.getElementById('spaceLocation').value);
      const typeId = parseInt(document.getElementById('spaceAdType').value);
      const quantity = parseInt(document.getElementById('spaceQuantity').value);
      const errorEl = document.getElementById('spaceError');
      errorEl.textContent = '';

      let stationId = null, trainId = null;

      if (location === 0) {
        stationId = parseInt(document.getElementById('spaceStation').value);
        if (!stationId || isNaN(stationId)) {
          errorEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é';
          return;
        }
      } else if (location === 1) {
        trainId = parseInt(document.getElementById('spaceTrain').value);
        if (!trainId || isNaN(trainId)) {
          errorEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–µ–∑–¥';
          return;
        }
      } else {
        errorEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é';
        return;
      }

      if (!typeId || isNaN(typeId) || !quantity || isNaN(quantity) || quantity < 1) {
        errorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ';
        return;
      }

      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–∏ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –º–µ—Å—Ç–∞?')) {
        return;
      }

      fetch('/cabinet/delete-ad-spaces', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ typeId, quantity, stationId, trainId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          document.getElementById('spaceLocation').value = '';
          document.getElementById('spaceAdType').value = '';
          document.getElementById('spaceLine').value = '';
          document.getElementById('spaceStation').value = '';
          document.getElementById('spaceTrain').value = '';
          document.getElementById('spaceQuantity').value = '';
          updateSpaceOptions();
        } else {
          errorEl.textContent = data.message;
        }
      })
      .catch(err => {
        console.error(err);
        errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
      });
    }

    function updateNavLink(page) {
      const links = document.querySelectorAll('.cabinet-nav .nav-link');
      links.forEach(link => link.classList.remove('active'));
      
      if (page === 'account') {
        const accountLink = document.querySelector('.cabinet-nav .nav-menu .nav-item:first-child .nav-link');
        if (accountLink) {
          accountLink.classList.add('active');
        }
      } else if (page === 'manage-users') {
        const manageLink = Array.from(links).find(link => link.textContent.includes('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏'));
        if (manageLink) {
          manageLink.classList.add('active');
        }
      } else if (page === 'manage-ad-types') {
        const manageAdTypesLink = Array.from(links).find(link => link.textContent.includes('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ —Ä–µ–∫–ª–∞–º—ã'));
        if (manageAdTypesLink) {
          manageAdTypesLink.classList.add('active');
        }
      } else if (page === 'manage-ad-spaces') {
        const manageAdSpacesLink = Array.from(links).find(link => link.textContent.includes('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏'));
        if (manageAdSpacesLink) {
          manageAdSpacesLink.classList.add('active');
        }
      }
    }

    function clearAdTypeForm() {
      document.getElementById('adTypeName').value = '';
      document.getElementById('adTypeDescription').value = '';
      document.getElementById('adTypeWidth').value = '';
      document.getElementById('adTypeHeight').value = '';
      document.getElementById('adTypeLocation').value = '0';
      document.getElementById('adTypeBasePrice').value = '';
      document.getElementById('adTypeError').textContent = '';
      delete document.getElementById('adTypeName').dataset.adTypeId;
    }
  </script>
</body>
</html>
